<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„èµ„é‡‘è½®åŠ¨æ“ä½œå° (V8.3 - æœ€ç»ˆç¨³å®šç‰ˆ)</title>
    <style>
        /* CSS styles are the same */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f0f2f5; margin: 0; padding: 20px; font-size: 13px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
        .page-header h1 { color: #0056b3; margin: 0; }
        .header-actions { display: flex; gap: 10px; }
        .header-btn { background: none; border: 1px solid #007bff; color: #007bff; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 1em; display: flex; align-items: center; gap: 5px; }
        .header-btn:hover { background-color: #e7f3ff; }
        .header-btn .icon { font-size: 1.5em; }
        #login-screen { display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; }
        .login-container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 320px; text-align: center; }
        .login-container h2 { margin-top: 0; }
        .login-container input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .login-container button { width: 100%; padding: 10px; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 1.1em; cursor: pointer; }
        .login-container .error-message { color: red; margin-top: 10px; visibility: hidden; }
        #main-content { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: center; vertical-align: top; }
        th { background-color: #007bff; color: white; font-weight: bold; position: relative; }
        tbody tr:nth-child(even) { background-color: #f2f2f2; }
        tbody tr:hover { background-color: #e9ecef; }
        .maturity-details { text-align: left; }
        .status-cell { padding: 4px; }
        .status-selector { display: flex; justify-content: center; gap: 4px; margin-bottom: 4px; }
        .status-btn { border: 2px solid #ccc; background-color: #f0f0f0; padding: 3px 10px; border-radius: 12px; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease-in-out; }
        .status-btn .icon { display: none; margin-right: 3px; }
        .status-btn.selected { font-weight: bold; transform: scale(1.05); box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .status-btn.selected .icon { display: inline; }
        .clean.selected { background-color: #d4edda; color: #155724; border-color: #28a745; }
        .cooling.selected { background-color: #f8d7da; color: #721c24; border-color: #dc3545; }
        .status-cell.is-clean { background-color: rgba(40, 167, 69, 0.05); }
        .status-cell.is-cooling { background-color: rgba(220, 53, 69, 0.05); }
        .remark-input { width: 90%; border: 1px solid #ced4da; border-radius: 4px; padding: 3px; font-size: 0.9em; }
        .decision-textarea { width: 98%; height: 70px; border: 1px solid #ced4da; border-radius: 4px; padding: 5px; font-size: 1em; resize: vertical; }
        .save-btn { background-color: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; font-size: 0.9em; }
        .save-feedback { font-size: 0.9em; color: green; font-weight: bold; margin-top: 4px; visibility: hidden; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-container">
            <h2>ç™»å½•æ‚¨çš„æ“ä½œå°</h2>
            <input type="email" id="email-input" value="snaagk@gmail.com" readonly>
            <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button id="login-button">ç™»å½•</button>
            <p id="error-message" class="error-message">å¯†ç é”™è¯¯æˆ–ç”¨æˆ·ä¸å­˜åœ¨</p>
        </div>
    </div>

    <div id="main-content">
        <div class="page-header">
            <h1>æˆ‘çš„èµ„é‡‘è½®åŠ¨æ“ä½œå°</h1>
            <div class="header-actions">
                <button id="refresh-button" class="header-btn" title="åˆ·æ–°æ•°æ®"><span class="icon">ğŸ”„</span> åˆ·æ–°</button>
                <button id="logout-button" class="header-btn" title="é€€å‡ºç™»å½•">é€€å‡ºç™»å½•</button>
            </div>
        </div>
        <table>
            <!-- Table structure -->
            <thead>
                 <tr>
                    <th rowspan="2">åˆ°æœŸæ¬¾é¡¹</th><th colspan="3">æ“ä½œå‰é“¶è¡ŒçŠ¶æ€</th><th rowspan="2" style="width: 25%;">å†³ç­–ä¸æ“ä½œæŒ‡ä»¤</th><th colspan="3">æ“ä½œåé“¶è¡ŒçŠ¶æ€</th><th rowspan="2">æ“ä½œ</th>
                </tr>
                <tr>
                    <th>æ±‡ä¸° (HSBC)</th><th>æ’ç”Ÿ (Hang Seng)</th><th>ä¸­é“¶ (BOC)</th><th>æ±‡ä¸° (HSBC)</th><th>æ’ç”Ÿ (Hang Seng)</th><th>ä¸­é“¶ (BOC)</th>
                </tr>
            </thead>
            <tbody id="plan-table-body"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCzu12D1_Bs13tZFc_wXWMKTzMOuXLOS_E",
          authDomain: "finance-tracker-67bb8.firebaseapp.com",
          projectId: "finance-tracker-67bb8",
          storageBucket: "finance-tracker-67bb8.appspot.com",
          messagingSenderId: "21367339999",
          appId: "1:21367339999:web:4485241cee3c920bd6a26a",
          measurementId: "G-K0PPFPCLSY"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- All functions are defined first ---

        async function handleLogin(emailInput, passwordInput, errorMessage) {
            const email = emailInput.value;
            const password = passwordInput.value;
            errorMessage.style.visibility = 'hidden';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                errorMessage.style.visibility = 'visible';
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }

        async function initializeMainApp(mainContent) {
            if (mainContent.dataset.initialized === 'true') return; // Prevent re-initialization
            
            generateTable();
            await loadDataFromFirebase();
            
            document.getElementById('plan-table-body').addEventListener('click', handleTableClick);
            document.getElementById('refresh-button').addEventListener('click', loadDataFromFirebase);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            
            mainContent.dataset.initialized = 'true';
        }

        function handleTableClick(e) {
            const statusButton = e.target.closest('.status-btn');
            const saveButton = e.target.closest('.save-btn');
            if (statusButton) {
                const parentCell = statusButton.closest('.status-cell');
                updateCellState(parentCell, statusButton.dataset.status);
            }
            if (saveButton) {
                saveRowData(saveButton.closest('tr'));
            }
        }

        function saveRowData(row) {
            const rowData = {
                id: row.dataset.rowId,
                maturityDate: row.cells[0].querySelector('strong').innerText,
                maturityBank: row.cells[0].innerText.split('\n')[1],
                maturityAmount: parseFloat(row.cells[0].innerText.split('$')[1]),
                before_hsbc_status: row.cells[1].dataset.state, before_hsbc_remark: row.cells[1].querySelector('.remark-input').value,
                before_hangseng_status: row.cells[2].dataset.state, before_hangseng_remark: row.cells[2].querySelector('.remark-input').value,
                before_boc_status: row.cells[3].dataset.state, before_boc_remark: row.cells[3].querySelector('.remark-input').value,
                decision: row.cells[4].querySelector('.decision-textarea').value,
                after_hsbc_status: row.cells[5].dataset.state, after_hsbc_remark: row.cells[5].querySelector('.remark-input').value,
                after_hangseng_status: row.cells[6].dataset.state, after_hangseng_remark: row.cells[6].querySelector('.remark-input').value,
                after_boc_status: row.cells[7].dataset.state, after_boc_remark: row.cells[7].querySelector('.remark-input').value,
                lastSaved: new Date().toISOString()
            };
            saveDataToFirebase(rowData, row.querySelector('.save-btn'));
        }

        // --- THE MAIN ENTRY POINT OF THE APPLICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get all DOM elements safely here
            const loginScreen = document.getElementById('login-screen');
            const mainContent = document.getElementById('main-content');
            const loginButton = document.getElementById('login-button');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const errorMessage = document.getElementById('error-message');

            // Attach login event listeners
            loginButton.addEventListener('click', () => handleLogin(emailInput, passwordInput, errorMessage));
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin(emailInput, passwordInput, errorMessage);
                }
            });

            // Firebase auth state listener
            onAuthStateChanged(auth, user => {
                if (user) {
                    loginScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    initializeMainApp(mainContent);
                } else {
                    mainContent.style.display = 'none';
                    loginScreen.style.display = 'flex';
                    mainContent.dataset.initialized = 'false';
                }
            });
        });

        // --- All Helper functions and data below ---
        const depositData = [ /* ... All 57 of your data entries ... */ ];
        function updateCellState(cell, newState) {if (!cell || !newState) return; cell.dataset.state = newState; cell.classList.remove('is-clean', 'is-cooling'); if (newState === 'clean') {cell.classList.add('is-clean');} else if (newState === 'cooling') {cell.classList.add('is-cooling');} const allButtons = cell.querySelectorAll('.status-btn'); allButtons.forEach(btn => btn.classList.remove('selected')); const selectedButton = cell.querySelector(`.status-btn[data-status="${newState}"]`); if (selectedButton) {selectedButton.classList.add('selected');}}
        function createStatusCell(prefix, bankName, rowId) {const cell = document.createElement('td'); cell.classList.add('status-cell'); cell.dataset.state = 'none'; cell.innerHTML = `<div class="status-selector"><span class="status-btn clean" data-status="clean"><span class="icon">âœ…</span>å¹²å‡€</span><span class="status-btn cooling" data-status="cooling"><span class="icon">â„ï¸</span>å†·å´</span></div><input type="text" class="remark-input" placeholder="å¤‡æ³¨...">`; return cell;}
        function generateTable() {const tableBody = document.getElementById('plan-table-body'); tableBody.innerHTML = ''; depositData.forEach((item, index) => {const rowId = `row-${index}`; const row = document.createElement('tr'); row.id = rowId; row.dataset.rowId = index; const maturityCell = document.createElement('td'); maturityCell.classList.add('maturity-details'); maturityCell.innerHTML = `<strong>${item.date}</strong><br>${item.bank}<br>$${item.amount.toFixed(2)}`; row.appendChild(maturityCell); row.appendChild(createStatusCell('before', 'hsbc', rowId)); row.appendChild(createStatusCell('before', 'hangseng', rowId)); row.appendChild(createStatusCell('before', 'boc', rowId)); const decisionCell = document.createElement('td'); decisionCell.innerHTML = `<textarea class="decision-textarea" placeholder="è¾“å…¥æ‚¨çš„å†³ç­–å’Œå…·ä½“æ“ä½œæŒ‡ä»¤..."></textarea>`; row.appendChild(decisionCell); row.appendChild(createStatusCell('after', 'hsbc', rowId)); row.appendChild(createStatusCell('after', 'hangseng', rowId)); row.appendChild(createStatusCell('after', 'boc', rowId)); const actionCell = document.createElement('td'); actionCell.innerHTML = `<button class="save-btn">ä¿å­˜</button><div class="save-feedback">å·²ä¿å­˜!</div>`; row.appendChild(actionCell); tableBody.appendChild(row);});}
        async function loadDataFromFirebase() {try {const querySnapshot = await getDocs(collection(db, "operations")); querySnapshot.forEach((doc) => {const data = doc.data(); const row = document.getElementById(`row-${data.id}`); if (row) {row.cells[4].querySelector('.decision-textarea').value = data.decision || ""; updateCellState(row.cells[1], data.before_hsbc_status || 'none'); row.cells[1].querySelector('.remark-input').value = data.before_hsbc_remark || ""; updateCellState(row.cells[2], data.before_hangseng_status || 'none'); row.cells[2].querySelector('.remark-input').value = data.before_hangseng_remark || ""; updateCellState(row.cells[3], data.before_boc_status || 'none'); row.cells[3].querySelector('.remark-input').value = data.before_boc_remark || ""; updateCellState(row.cells[5], data.after_hsbc_status || 'none'); row.cells[5].querySelector('.remark-input').value = data.after_hsbc_remark || ""; updateCellState(row.cells[6], data.after_hangseng_status || 'none'); row.cells[6].querySelector('.remark-input').value = data.after_hangseng_remark || ""; updateCellState(row.cells[7], data.after_boc_status || 'none'); row.cells[7].querySelector('.remark-input').value = data.after_boc_remark || "";}}); } catch (error) {console.error("Error loading data from Firestore: ", error);}}
        async function saveDataToFirebase(data, button) {button.innerText = "ä¿å­˜ä¸­..."; button.disabled = true; const feedback = button.nextElementSibling; const docId = `operation-${data.id}`; try {await setDoc(doc(db, "operations", docId), data, { merge: true }); feedback.style.visibility = "visible"; setTimeout(() => { feedback.style.visibility = "hidden"; }, 2000);} catch (error) {console.error("Error writing document: ", error);} finally {button.innerText = "ä¿å­˜"; button.disabled = false;}}
        const fullDepositData = [
            { date: "2025-09-05", bank: "BOC HK", amount: 4912.00 }, { date: "2025-09-10", bank: "HSBC", amount: 19760.00 }, { date: "2025-09-12", bank: "HSBC", amount: 5630.00 }, { date: "2025-09-12", bank: "BOC HK", amount: 8782.00 }, { date: "2025-09-12", bank: "Hang Seng HK", amount: 10000.00 }, { date: "2025-09-19", bank: "HSBC HK", amount: 9400.00 }, { date: "2025-09-29", bank: "HSBC HK", amount: 9881.00 }, { date: "2025-10-02", bank: "HSBC", amount: 5200.00 }, { date: "2025-10-08", bank: "Hang Seng HK", amount: 7067.00 }, { date: "2025-10-15", bank: "HSBC", amount: 11288.00 }, { date: "2025-10-24", bank: "HSBC HK", amount: 10000.00 }, { date: "2025-10-27", bank: "HSBC HK", amount: 9760.00 }, { date: "2025-10-30", bank: "HSBC", amount: 20380.00 }, { date: "2025-11-03", bank: "HSBC", amount: 10000.00 }, { date: "2025-11-06", bank: "HSBC", amount: 10138.00 }, { date: "2025-11-06", bank: "BOC HK", amount: 16632.00 }, { date: "2025-11-13", bank: "HSBC HK", amount: 12500.00 }, { date: "2025-11-20", bank: "HSBC", amount: 4880.00 }, { date: "2025-12-05", bank: "HSBC HK", amount: 11000.00 }, { date: "2025-12-05", bank: "BOC HK", amount: 4903.50 }, { date: "2025-12-08", bank: "BOC HK", amount: 11264.68 }, { date: "2025-12-15", bank: "HSBC", amount: 4940.00 }, { date: "2025-12-17", bank: "HSBC", amount: 9800.00 }, { date: "2025-12-29", bank: "HSBC", amount: 4560.00 }, { date: "2025-12-30", bank: "HSBC", amount: 5140.00 }, { date: "2026-01-22", bank: "HSBC", amount: 4632.00 }, { date: "2026-01-26", bank: "HSBC", amount: 5248.00 }, { date: "2026-01-28", bank: "HSBC", amount: 4940.00 }, { date: "2026-02-11", bank: "HSBC", amount: 4700.00 }, { date: "2026-02-20", bank: "HSBC", amount: 5100.00 }, { date: "2026-05-20", bank: "HSBC HK", amount: 8700.00 }, { date: "2026-05-21", bank: "HSBC", amount: 7100.00 }, { date: "2026-05-22", bank: "HSBC", amount: 5000.00 }, { date: "2026-06-02", bank: "HSBC", amount: 14820.00 }, { date: "2026-06-18", bank: "Hang Seng", amount: 8455.00 }, { date: "2026-06-23", bank: "Hang Seng", amount: 8994.00 }, { date: "2026-06-29", bank: "HSBC", amount: 5600.00 }, { date: "2026-06-30", bank: "HSBC", amount: 9231.00 }, { date: "2026-07-02", bank: "HSBC", amount: 5200.00 }, { date: "2026-07-08", bank: "HSBC", amount: 20000.00 }, { date: "2026-07-16", bank: "HSBC", amount: 12900.00 }, { date: "2026-07-16", bank: "Hang Seng", amount: 17281.00 }, { date: "2026-07-23", bank: "HSBC", amount: 14900.00 }, { date: "2026-07-30", bank: "HSBC", amount: 9500.00 }, { date: "2026-08-06", bank: "HSBC", amount: 9500.00 }, { date: "2026-08-10", bank: "HSBC", amount: 5200.00 }, { date: "2026-08-13", bank: "HSBC", amount: 4850.00 }, { date: "2026-08-13", bank: "Hang Seng", amount: 16462.00 }, { date: "2026-08-18", bank: "Hang Seng", amount: 10166.83 }, { date: "2026-08-20", bank: "HSBC", amount: 12900.00 }, { date: "2026-08-25", bank: "Hang Seng HK", amount: 10904.00 }, { date: "2026-08-27", bank: "HSBC", amount: 13600.00 }, { date: "2026-08-27", bank: "Hang Seng", amount: 16144.00 }, { date: "2026-09-03", bank: "HSBC", amount: 14820.00 }, { date: "2026-09-03", bank: "Hang Seng", amount: 19435.35 }, { date: "2026-09-04", bank: "HSBC", amount: 4940.00 }
        ];
        // The depositData variable was renamed fullDepositData, this ensures it works.
        depositData.splice(0, depositData.length, ...fullDepositData);

    </script>
</body>
</html>
