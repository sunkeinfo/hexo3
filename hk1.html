<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„èµ„é‡‘è½®åŠ¨æ“ä½œå° (V10 - é›†æˆæ–°å¢è¡Œ)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f0f2f5; margin: 0; padding: 20px; font-size: 13px; }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            flex-wrap: wrap;
            position: -webkit-sticky;
            position: sticky;
            top: -20px;
            background-color: #f0f2f5;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .page-header h1 { color: #0056b3; margin: 10px 0; }
        .header-actions { display: flex; flex-wrap: wrap; gap: 10px; }
        .header-btn, .action-btn { background: #fff; border: 1px solid #007bff; color: #007bff; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 1em; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .header-btn:hover, .action-btn:hover { background-color: #e7f3ff; }
        .header-btn .icon { font-size: 1.5em; }
        #login-screen { display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; }
        .login-container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 320px; text-align: center; }
        .login-container h2 { margin-top: 0; }
        .login-container input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .login-container button { width: 100%; padding: 10px; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 1.1em; cursor: pointer; }
        .login-container .error-message { color: red; margin-top: 10px; visibility: hidden; }
        #main-content { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #fff; }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: center; vertical-align: top; }
        
        /* --- ä¿®æ”¹/æ–°å¢çš„æ ·å¼ï¼Œç”¨äºå›ºå®šè¡¨å¤´ --- */
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            position: -webkit-sticky; /* è®©è¡¨å¤´å•å…ƒæ ¼ä¹Ÿå˜æˆç²˜æ€§å®šä½ */
            position: sticky;
            z-index: 99; /* å±‚çº§ä½äºä¸»èœå•æ ï¼Œä½†é«˜äºè¡¨æ ¼å†…å®¹ */
        }
        /* ä¸ºç¬¬ä¸€è¡Œè¡¨å¤´è®¾ç½®å›ºå®šçš„ top å€¼ */
        thead tr:first-of-type th {
            top: 64px; /* è¿™ä¸ªå€¼çº¦ç­‰äºä¸Šæ–¹å·²å›ºå®šçš„ä¸»èœå•æ çš„é«˜åº¦ï¼Œå¯èƒ½éœ€è¦å¾®è°ƒ */
        }
        /* ä¸ºç¬¬äºŒè¡Œè¡¨å¤´è®¾ç½®å›ºå®šçš„ top å€¼ï¼Œä½¿å…¶ç´§è´´ç¬¬ä¸€è¡Œä¸‹æ–¹ */
        thead tr:nth-of-type(2) th {
            top: 105px; /* è¿™ä¸ªå€¼çº¦ç­‰äº ä¸»èœå•æ é«˜åº¦(64px) + ç¬¬ä¸€è¡Œè¡¨å¤´é«˜åº¦(41px) */
        }
        /* --- ç»“æŸä¿®æ”¹ --- */

        tbody tr:nth-child(even) { background-color: #f8f9fa; }
        tbody tr:hover { background-color: #e9ecef; }
        tfoot tr { background-color: #fdfdff; border-top: 2px solid #007bff; }
        tfoot td { padding: 12px 8px; }
        tfoot .input-group { display: flex; flex-direction: column; gap: 4px; align-items: stretch; }
        tfoot .input-group input { width: 95%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .add-btn { background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; transition: background-color 0.2s; }
        .add-btn:hover { background-color: #c82333; }
        .maturity-details { text-align: left; }
        .status-cell { padding: 4px; }
        .status-selector { display: flex; justify-content: center; gap: 4px; margin-bottom: 4px; }
        .status-btn { border: 2px solid #ccc; background-color: #f0f0f0; padding: 3px 10px; border-radius: 12px; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease-in-out; }
        .status-btn .icon { display: none; margin-right: 3px; }
        .status-btn.selected { font-weight: bold; transform: scale(1.05); box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .status-btn.selected .icon { display: inline; }
        .clean.selected { background-color: #d4edda; color: #155724; border-color: #28a745; }
        .cooling.selected { background-color: #f8d7da; color: #721c24; border-color: #dc3545; }
        .status-cell.is-clean { background-color: rgba(40, 167, 69, 0.05); }
        .status-cell.is-cooling { background-color: rgba(220, 53, 69, 0.05); }
        .remark-input { width: 90%; border: 1px solid #ced4da; border-radius: 4px; padding: 3px; font-size: 0.9em; }
        .decision-textarea { width: 98%; height: 70px; border: 1px solid #ced4da; border-radius: 4px; padding: 5px; font-size: 1em; resize: vertical; }
        .save-btn { background-color: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; font-size: 0.9em; }
        .save-feedback { font-size: 0.9em; color: green; font-weight: bold; margin-top: 4px; visibility: hidden; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-container">
            <h2>ç™»å½•æ‚¨çš„æ“ä½œå°</h2>
            <input type="email" id="email-input" value="snaagk@gmail.com" readonly>
            <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button id="login-button">ç™»å½•</button>
            <p id="error-message" class="error-message">å¯†ç é”™è¯¯æˆ–ç”¨æˆ·ä¸å­˜åœ¨</p>
        </div>
    </div>

    <div id="main-content">
        <div class="page-header">
            <h1>æˆ‘çš„èµ„é‡‘è½®åŠ¨æ“ä½œå°</h1>
            <div class="header-actions">
                <button id="import-btn" class="header-btn">ğŸ“¥ å¯¼å…¥CSV</button>
                <button id="export-btn" class="header-btn">ğŸ“¤ å¯¼å‡ºCSV</button>
                <button id="refresh-button" class="header-btn"><span class="icon">ğŸ”„</span> åˆ·æ–°</button>
                <button id="logout-button" class="header-btn">é€€å‡ºç™»å½•</button>
            </div>
        </div>
        
        <table>
            <thead>
                 <tr>
                    <th rowspan="2">åˆ°æœŸæ¬¾é¡¹</th><th colspan="3">æ“ä½œå‰é“¶è¡ŒçŠ¶æ€</th><th rowspan="2" style="width: 25%;">å†³ç­–ä¸æ“ä½œæŒ‡ä»¤</th><th colspan="3">æ“ä½œåé“¶è¡ŒçŠ¶æ€</th><th rowspan="2">æ“ä½œ</th>
                </tr>
                <tr>
                    <th>æ±‡ä¸° (HSBC)</th><th>æ’ç”Ÿ (Hang Seng)</th><th>ä¸­é“¶ (BOC)</th><th>æ±‡ä¸° (HSBC)</th><th>æ’ç”Ÿ (Hang Seng)</th><th>ä¸­é“¶ (BOC)</th>
                </tr>
            </thead>
            <tbody id="plan-table-body"></tbody>
            <tfoot>
                <tr>
                    <td>
                        <div class="input-group">
                            <input type="date" id="new-date" required>
                            <input type="text" id="new-bank" placeholder="é“¶è¡Œ (ä¾‹å¦‚: HSBC)" required>
                            <input type="number" id="new-amount" step="0.01" placeholder="é‡‘é¢ (USD)" required>
                        </div>
                    </td>
                    <td colspan="6"></td>
                    <td>
                        <button id="add-new-btn" class="add-btn">æ·»åŠ åˆ°æ•°æ®åº“</button>
                    </td>
                </tr>
            </tfoot>
        </table>
        
        <input type="file" id="import-file-input" style="display: none;" accept=".csv">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, getDocs, addDoc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCzu12D1_Bs13tZFc_wXWMKTzMOuXLOS_E",
          authDomain: "finance-tracker-67bb8.firebaseapp.com",
          projectId: "finance-tracker-67bb8",
          storageBucket: "finance-tracker-67bb8.appspot.com",
          messagingSenderId: "21367339999",
          appId: "1:21367339999:web:4485241cee3c920bd6a26a",
          measurementId: "G-K0PPFPCLSY"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const operationsCollection = collection(db, "operations");

        async function handleLogin(emailInput, passwordInput, errorMessage) {
            errorMessage.style.visibility = 'hidden';
            try { await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } 
            catch (error) { console.error("Login failed:", error); errorMessage.style.visibility = 'visible'; }
        }

        async function handleLogout() {
            try { await signOut(auth); } catch (error) { console.error("Sign out error:", error); }
        }

        async function initializeMainApp(mainContent) {
            if (mainContent.dataset.initialized === 'true') return;
            
            const tableBody = document.getElementById('plan-table-body');
            const importFileInput = document.getElementById('import-file-input');

            await loadAndRenderTableFromFirebase(tableBody);
            
            document.getElementById('plan-table-body').addEventListener('click', handleTableClick);
            document.getElementById('refresh-button').addEventListener('click', () => loadAndRenderTableFromFirebase(tableBody));
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('export-btn').addEventListener('click', handleExport);
            document.getElementById('import-btn').addEventListener('click', () => importFileInput.click());
            document.getElementById('add-new-btn').addEventListener('click', () => handleAddNew(tableBody));
            importFileInput.addEventListener('change', (e) => handleImport(e, importFileInput, tableBody));
            
            mainContent.dataset.initialized = 'true';
        }

        function handleTableClick(e) {
            const statusButton = e.target.closest('.status-btn');
            const saveButton = e.target.closest('.save-btn');
            if (statusButton) {
                updateCellState(statusButton.closest('.status-cell'), statusButton.dataset.status);
            }
            if (saveButton) {
                saveRowData(saveButton.closest('tr'));
            }
        }

        async function saveRowData(row) {
            const docId = row.dataset.docId;
            if (!docId) return;
            const rowData = {
                date: row.querySelector('.maturity-details strong').innerText,
                bank: row.querySelector('.maturity-details').innerText.split('\n')[1],
                amount: parseFloat(row.querySelector('.maturity-details').innerText.split('$')[1]),
                before_hsbc_status: row.cells[1].dataset.state, before_hsbc_remark: row.cells[1].querySelector('.remark-input').value,
                before_hangseng_status: row.cells[2].dataset.state, before_hangseng_remark: row.cells[2].querySelector('.remark-input').value,
                before_boc_status: row.cells[3].dataset.state, before_boc_remark: row.cells[3].querySelector('.remark-input').value,
                decision: row.cells[4].querySelector('.decision-textarea').value,
                after_hsbc_status: row.cells[5].dataset.state, after_hsbc_remark: row.cells[5].querySelector('.remark-input').value,
                after_hangseng_status: row.cells[6].dataset.state, after_hangseng_remark: row.cells[6].querySelector('.remark-input').value,
                after_boc_status: row.cells[7].dataset.state, after_boc_remark: row.cells[7].querySelector('.remark-input').value,
            };
            await saveDataToFirebase(docId, rowData, row.querySelector('.save-btn'));
        }

        async function loadAndRenderTableFromFirebase(tableBody) {
            tableBody.innerHTML = '<tr><td colspan="8">åŠ è½½ä¸­...</td></tr>';
            const q = query(operationsCollection, orderBy("date", "asc"));
            const querySnapshot = await getDocs(q);
            tableBody.innerHTML = '';
            if (querySnapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="8">æ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®ã€‚è¯·ä½¿ç”¨â€œå¯¼å…¥â€åŠŸèƒ½æ·»åŠ åˆå§‹æ•°æ®ã€‚</td></tr>';
                return;
            }
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const docId = doc.id;
                const row = document.createElement('tr');
                row.dataset.docId = docId;
                const maturityCell = document.createElement('td');
                maturityCell.classList.add('maturity-details');
                maturityCell.innerHTML = `<strong>${data.date}</strong><br>${data.bank}<br>$${Number(data.amount).toFixed(2)}`;
                row.appendChild(maturityCell);
                row.appendChild(createStatusCell()); row.appendChild(createStatusCell()); row.appendChild(createStatusCell());
                const decisionCell = document.createElement('td');
                decisionCell.innerHTML = `<textarea class="decision-textarea"></textarea>`;
                row.appendChild(decisionCell);
                row.appendChild(createStatusCell()); row.appendChild(createStatusCell()); row.appendChild(createStatusCell());
                const actionCell = document.createElement('td');
                actionCell.innerHTML = `<button class="save-btn">ä¿å­˜</button><div class="save-feedback">å·²ä¿å­˜!</div>`;
                row.appendChild(actionCell);
                tableBody.appendChild(row);
                row.cells[4].querySelector('.decision-textarea').value = data.decision || "";
                updateCellState(row.cells[1], data.before_hsbc_status || 'none'); row.cells[1].querySelector('.remark-input').value = data.before_hsbc_remark || "";
                updateCellState(row.cells[2], data.before_hangseng_status || 'none'); row.cells[2].querySelector('.remark-input').value = data.before_hangseng_remark || "";
                updateCellState(row.cells[3], data.before_boc_status || 'none'); row.cells[3].querySelector('.remark-input').value = data.before_boc_remark || "";
                updateCellState(row.cells[5], data.after_hsbc_status || 'none'); row.cells[5].querySelector('.remark-input').value = data.after_hsbc_remark || "";
                updateCellState(row.cells[6], data.after_hangseng_status || 'none'); row.cells[6].querySelector('.remark-input').value = data.after_hangseng_remark || "";
                updateCellState(row.cells[7], data.after_boc_status || 'none'); row.cells[7].querySelector('.remark-input').value = data.after_boc_remark || "";
            });
        }
        
        async function handleAddNew(tableBody) {
            const newDate = document.getElementById('new-date').value;
            const newBank = document.getElementById('new-bank').value;
            const newAmount = parseFloat(document.getElementById('new-amount').value);
            if (!newDate || !newBank || isNaN(newAmount) || newAmount <= 0) { alert("è¯·åœ¨è¡¨æ ¼åº•éƒ¨çš„â€œæ–°å¢è¡Œâ€ä¸­æ­£ç¡®å¡«å†™æ‰€æœ‰å­—æ®µã€‚"); return; }
            try {
                await addDoc(operationsCollection, { date: newDate, bank: newBank, amount: newAmount, before_hsbc_status: 'none', before_hsbc_remark: '', before_hangseng_status: 'none', before_hangseng_remark: '', before_boc_status: 'none', before_boc_remark: '', decision: '', after_hsbc_status: 'none', after_hsbc_remark: '', after_hangseng_status: 'none', after_hangseng_remark: '', after_boc_status: 'none', after_boc_remark: '' });
                document.getElementById('new-date').value = '';
                document.getElementById('new-bank').value = '';
                document.getElementById('new-amount').value = '';
                await loadAndRenderTableFromFirebase(tableBody);
            } catch (error) { console.error("Error adding new document: ", error); alert("æ–°å¢å¤±è´¥ã€‚"); }
        }

        async function handleExport() {
            const q = query(operationsCollection, orderBy("date", "asc"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { alert("æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºã€‚"); return; }
            const headers = ["date", "bank", "amount", "decision", "before_hsbc_status", "before_hsbc_remark", "before_hangseng_status", "before_hangseng_remark", "before_boc_status", "before_boc_remark", "after_hsbc_status", "after_hsbc_remark", "after_hangseng_status", "after_hangseng_remark", "after_boc_status", "after_boc_remark"];
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const row = headers.map(header => `"${(data[header] || '').toString().replace(/"/g, '""')}"`);
                csvContent += row.join(",") + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `operations_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function handleImport(event, importFileInput, tableBody) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm("è­¦å‘Šï¼šå¯¼å…¥å°†åˆ é™¤æ‰€æœ‰ç°æœ‰äº‘ç«¯æ•°æ®ï¼Œå¹¶ç”¨æ–‡ä»¶ä¸­çš„å†…å®¹è¦†ç›–ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) {
                importFileInput.value = ""; return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const existingDocs = await getDocs(operationsCollection);
                    const deleteBatch = writeBatch(db);
                    existingDocs.forEach(doc => deleteBatch.delete(doc.ref));
                    await deleteBatch.commit();
                    const text = e.target.result;
                    const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
                    if (lines.length <= 1) { alert("CSVæ–‡ä»¶ä¸ºç©ºæˆ–åªæœ‰è¡¨å¤´ã€‚"); return; }
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const addBatch = writeBatch(db);
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        const obj = {};
                        headers.forEach((header, index) => {
                            let value = values[index] || '';
                            if (value.startsWith('"') && value.endsWith('"')) { value = value.substring(1, value.length - 1).replace(/""/g, '"'); }
                            obj[header] = header === 'amount' ? parseFloat(value) : value;
                        });
                        addBatch.set(doc(operationsCollection), obj);
                    }
                    await addBatch.commit();
                    alert(`æˆåŠŸå¯¼å…¥ ${lines.length - 1} æ¡è®°å½•ã€‚`);
                    await loadAndRenderTableFromFirebase(tableBody);
                } catch (err) { console.error("Import failed: ", err); alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¡®ä¿CSVæ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚"); } 
                finally { importFileInput.value = ""; }
            };
            reader.readAsText(file);
        }

        function updateCellState(cell, newState) { if (!cell || !newState) return; cell.dataset.state = newState; cell.classList.remove('is-clean', 'is-cooling'); if (newState === 'clean') {cell.classList.add('is-clean');} else if (newState === 'cooling') {cell.classList.add('is-cooling');} const allButtons = cell.querySelectorAll('.status-btn'); allButtons.forEach(btn => btn.classList.remove('selected')); const selectedButton = cell.querySelector(`.status-btn[data-status="${newState}"]`); if (selectedButton) {selectedButton.classList.add('selected');} }
        function createStatusCell() { const cell = document.createElement('td'); cell.classList.add('status-cell'); cell.dataset.state = 'none'; cell.innerHTML = `<div class="status-selector"><span class="status-btn clean" data-status="clean"><span class="icon">âœ…</span>å¹²å‡€</span><span class="status-btn cooling" data-status="cooling"><span class="icon">â„ï¸</span>å†·å´</span></div><input type="text" class="remark-input" placeholder="å¤‡æ³¨...">`; return cell; }
        async function saveDataToFirebase(docId, data, button) { button.innerText = "ä¿å­˜ä¸­..."; button.disabled = true; const feedback = button.nextElementSibling; try { await setDoc(doc(db, "operations", docId), data, { merge: true }); feedback.style.visibility = "visible"; setTimeout(() => { feedback.style.visibility = "hidden"; }, 2000); } catch (error) { console.error("Error writing document: ", error); } finally { button.innerText = "ä¿å­˜"; button.disabled = false; } }
        
        document.addEventListener('DOMContentLoaded', () => {
            const loginScreen = document.getElementById('login-screen');
            const mainContent = document.getElementById('main-content');
            const loginButton = document.getElementById('login-button');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const errorMessage = document.getElementById('error-message');

            loginButton.addEventListener('click', () => handleLogin(emailInput, passwordInput, errorMessage));
            passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(emailInput, passwordInput, errorMessage); });

            onAuthStateChanged(auth, user => {
                if (user) {
                    loginScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    initializeMainApp(mainContent);
                } else {
                    mainContent.style.display = 'none';
                    loginScreen.style.display = 'flex';
                    mainContent.dataset.initialized = 'false';
                }
            });
        });
    </script>
</body>
</html>
