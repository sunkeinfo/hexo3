<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动态存款管理应用 (Firebase)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; background-color: #f4f7f9; color: #333; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-box { background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 380px; }
        .login-box h2 { margin-top: 0; color: #2c3e50; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #bdc3c7; font-size: 16px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; border: none; border-radius: 5px; background-color: #3498db; color: white; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        .login-box button:hover { background-color: #2980b9; }
        #login-error { color: #e74c3c; margin-top: 10px; height: 1em; }
        #app-content, #loading-indicator { display: none; }
        #loading-indicator { text-align: center; font-size: 1.5em; color: #7f8c8d; margin-top: 50px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; }
        #logout-btn { background: #e74c3c; padding: 8px 15px; font-size: 14px; width: auto; }
        #logout-btn:hover { background: #c0392b; }
        .container { max-width: 1200px; margin: 20px auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h1 { text-align: center; margin-bottom: 30px; }
        .main-layout { display: flex; flex-wrap: wrap; gap: 30px; }
        .left-column { flex: 3; min-width: 300px; }
        .right-column { flex: 1; min-width: 280px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: #3498db; color: #fff; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        #add-deposit-form { padding: 20px; background-color: #ecf0f1; border-radius: 8px; display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; color: #7f8c8d; }
        input, select, button { padding: 10px; border-radius: 5px; border: 1px solid #bdc3c7; font-size: 16px; box-sizing: border-box; width: 100%; }
        button { cursor: pointer; transition: background-color 0.3s; border: none; color: white; }
        .add-btn { background-color: #2ecc71; margin-top: 10px; }
        .add-btn:hover { background-color: #27ae60; }
        .edit-btn { background-color: #f39c12; margin-right: 5px; }
        .edit-btn:hover { background-color: #e67e22; }
        .delete-btn { background-color: #e74c3c; }
        .delete-btn:hover { background-color: #c0392b; }
        #total-summary { font-size: 1.2em; font-weight: bold; margin-top: 20px; padding: 15px; background-color: #eaf5ff; border-left: 5px solid #3498db; }
        footer { text-align: center; margin-top: 30px; color: #7f8c8d; font-size: 0.9em; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { margin-top: 0; }
        .modal-content form { flex-direction: column; align-items: stretch; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-buttons button { width: auto; padding: 10px 20px; }
        .save-btn { background-color: #3498db; }
        .save-btn:hover { background-color: #2980b9; }
        .cancel-btn { background-color: #95a5a6; }
        .cancel-btn:hover { background-color: #7f8c8d; }
        @media (max-width: 800px) { .main-layout { flex-direction: column; } }
    </style>
</head>
<body>

<!-- 登录界面 -->
<div id="login-overlay">
    <div class="login-box">
        <h2>安全登录</h2>
        <form id="login-form">
            <!-- *** 修改点 1: 添加 value 属性 *** -->
            <input type="email" id="email" value="snaagk@gmail.com" required>
            
            <!-- *** 修改点 2: 添加 autofocus 属性 *** -->
            <input type="password" id="password" placeholder="请输入密码" required autofocus>
            
            <button type="submit">登录</button>
            <p id="login-error"></p>
        </form>
    </div>
</div>

<!-- 加载指示器 -->
<div id="loading-indicator">正在验证身份...</div>

<!-- 主应用 -->
<div id="app-content">
    <div class="container">
        <div class="header-bar">
            <h1>动态存款管理</h1>
            <button id="logout-btn">登出</button>
        </div>
        <div class="main-layout">
            <div class="left-column">
                <h2>存款列表</h2>
                <div id="total-summary">正在从云端加载数据...</div>
                <table>
                    <thead><tr><th>到期日期</th><th>银行</th><th>金额 (USD)</th><th>操作</th></tr></thead>
                    <tbody id="deposit-list"></tbody>
                </table>
            </div>
            <div class="right-column">
                <h2>新增存款</h2>
                <form id="add-deposit-form">
                    <div class="form-group"><label for="bank">银行</label><select id="bank" required><option value="HSBC">汇丰银行 (HSBC)</option><option value="HSBC HK">汇丰香港 (HSBC HK)</option><option value="BOC HK">中国银行香港 (BOC HK)</option><option value="Hang Seng">恒生银行 (Hang Seng)</option></select></div>
                    <div class="form-group"><label for="amount">金额 (USD)</label><input type="number" id="amount" placeholder="例如: 10000" required step="0.01"></div>
                    <div class="form-group"><label for="due-date">到期日期</label><input type="date" id="due-date" required></div>
                    <button type="submit" class="add-btn">添加记录</button>
                </form>
            </div>
        </div>
        <footer><p>数据库来源: Firebase (snaagk@gmail.com 的账户)</p></footer>
    </div>
</div>

<!-- 修改模态框 -->
<div id="edit-modal-overlay" class="modal-overlay">
    <div class="modal-content">
        <h2>修改存款记录</h2>
        <form id="edit-deposit-form">
            <input type="hidden" id="edit-doc-id">
            <div class="form-group"><label for="edit-bank">银行</label><select id="edit-bank" required><option value="HSBC">汇丰银行 (HSBC)</option><option value="HSBC HK">汇丰香港 (HSBC HK)</option><option value="BOC HK">中国银行香港 (BOC HK)</option><option value="Hang Seng">恒生银行 (Hang Seng)</option></select></div>
            <div class="form-group"><label for="edit-amount">金额 (USD)</label><input type="number" id="edit-amount" required step="0.01"></div>
            <div class="form-group"><label for="edit-due-date">到期日期</label><input type="date" id="edit-due-date" required></div>
            <div class="modal-buttons"><button type="button" id="cancel-edit-btn" class="cancel-btn">取消</button><button type="submit" class="save-btn">保存更改</button></div>
        </form>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
    // =================================================================================
    // 1. 您的 Firebase 项目配置信息
    // =================================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyAJi_b6dKtcZ5fed8DZOKzb9gxcCUyDTyU",
        authDomain: "august2025-b3d90.firebaseapp.com",
        projectId: "august2025-b3d90",
        storageBucket: "august2025-b3d90.firebasestorage.app",
        messagingSenderId: "864895118795",
        appId: "1:864895118795:web:ccc39cb610a71328a79a4e",
        measurementId: "G-3EFP14G8XQ"
    };

    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // =================================================================================
    // 2. 获取页面元素
    // =================================================================================
    const loginOverlay = document.getElementById('login-overlay');
    const appContent = document.getElementById('app-content');
    const loadingIndicator = document.getElementById('loading-indicator');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logout-btn');
    
    let depositsCollection;
    let unsubscribe;

    // =================================================================================
    // 3. 身份验证状态监听 (核心逻辑)
    // =================================================================================
    auth.onAuthStateChanged(user => {
        if (user) {
            loginOverlay.style.display = 'none';
            appContent.style.display = 'block';
            loadingIndicator.style.display = 'none';
            depositsCollection = db.collection('deposits');
            startListeningForDeposits();
        } else {
            loginOverlay.style.display = 'flex';
            appContent.style.display = 'none';
            loadingIndicator.style.display = 'none';
            if (unsubscribe) {
                unsubscribe();
            }
        }
    });

    // =================================================================================
    // 4. 登录和登出逻辑
    // =================================================================================
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = loginForm.email.value;
        const password = loginForm.password.value;
        loginError.textContent = '';
        auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
                console.error('登录失败:', error);
                loginError.textContent = '登录失败，请检查邮箱和密码。';
            });
    });
    logoutBtn.addEventListener('click', () => {
        auth.signOut();
    });

    // =================================================================================
    // 5. 数据库交互逻辑
    // =================================================================================
    const addForm = document.getElementById('add-deposit-form');
    const depositList = document.getElementById('deposit-list');
    const totalSummary = document.getElementById('total-summary');

    function startListeningForDeposits() {
        unsubscribe = depositsCollection.orderBy('dueDate', 'asc').onSnapshot(snapshot => {
            let totalAmount = 0;
            depositList.innerHTML = ''; 
            if (snapshot.empty) {
                depositList.innerHTML = '<tr><td colspan="4">暂无数据，请添加第一条存款记录。</td></tr>';
            } else {
                snapshot.forEach(doc => {
                    const deposit = doc.data();
                    const amount = parseFloat(deposit.amount);
                    totalAmount += amount;
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${deposit.dueDate}</td><td>${deposit.bank}</td><td>${amount.toFixed(2)}</td><td><button class="edit-btn" data-id="${doc.id}">修改</button><button class="delete-btn" data-id="${doc.id}">删除</button></td>`;
                    depositList.appendChild(row);
                });
            }
            totalSummary.textContent = `所有银行存款总计: ${totalAmount.toFixed(2)} USD`;
        }, error => {
            console.error("读取数据库失败: ", error);
            totalSummary.textContent = "错误：无法从数据库加载数据。可能是权限问题。";
        });
    }

    addForm.addEventListener('submit', (e) => { e.preventDefault(); depositsCollection.add({ bank: addForm.bank.value, amount: Number(addForm.amount.value), dueDate: addForm['due-date'].value, createdAt: firebase.firestore.FieldValue.serverTimestamp() }).then(() => addForm.reset()).catch(err => console.error('添加失败: ', err)); });
    depositList.addEventListener('click', (e) => { const docId = e.target.getAttribute('data-id'); if (!docId) return; if (e.target.classList.contains('delete-btn')) { if (confirm('您确定要删除这条记录吗?')) { depositsCollection.doc(docId).delete().catch(err => console.error('删除失败: ', err)); } } if (e.target.classList.contains('edit-btn')) { depositsCollection.doc(docId).get().then(doc => { if (doc.exists) { const data = doc.data(); editDocId.value = doc.id; editBank.value = data.bank; editAmount.value = data.amount; editDueDate.value = data.dueDate; editModalOverlay.style.display = 'flex'; } }); } });
    const editModalOverlay = document.getElementById('edit-modal-overlay'); const editForm = document.getElementById('edit-deposit-form'); const cancelEditBtn = document.getElementById('cancel-edit-btn'); const editDocId = document.getElementById('edit-doc-id'); const editBank = document.getElementById('edit-bank'); const editAmount = document.getElementById('edit-amount'); const editDueDate = document.getElementById('edit-due-date');
    editForm.addEventListener('submit', (e) => { e.preventDefault(); const docId = editDocId.value; depositsCollection.doc(docId).update({ bank: editBank.value, amount: Number(editAmount.value), dueDate: editDueDate.value }).then(() => closeEditModal()).catch(err => console.error('更新失败: ', err)); });
    function closeEditModal() { editModalOverlay.style.display = 'none'; }
    cancelEditBtn.addEventListener('click', closeEditModal);
    editModalOverlay.addEventListener('click', (e) => { if (e.target === editModalOverlay) { closeEditModal(); } });
</script>

</body>
</html>
